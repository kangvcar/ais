# æ–‡æ¡£ç½‘ç«™å®¹å™¨æž„å»ºå’Œéƒ¨ç½²å·¥ä½œæµ
# æž„å»ºVitePressæ–‡æ¡£ç½‘ç«™å¹¶å‘å¸ƒåˆ°DockerHub
name: Docs Container Deploy

on:
  # å½“docsç›®å½•æˆ–ç›¸å…³æ–‡ä»¶å‘ç”Ÿå˜æ›´æ—¶è§¦å‘
  push:
    branches: [main]
    paths:
      - 'docs/**'
      - 'package.json'
      - 'package-lock.json'
      - 'netlify.toml'
      - 'vercel.json'
      - 'docs.Dockerfile'
      - '.github/workflows/docs-container-deploy.yml'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘æž„å»º
  workflow_dispatch:
    inputs:
      tag:
        description: 'Docker tag for docs image'
        required: false
        default: 'latest'
        type: string
      platforms:
        description: 'Target platforms'
        required: false
        default: 'linux/amd64,linux/arm64'
        type: string

# é™åˆ¶å¹¶å‘æ‰§è¡Œ
concurrency:
  group: docs-container-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: docker.io
  IMAGE_NAME: kangvcar/ais-docs

jobs:
  # æž„å»ºå’ŒæŽ¨é€æ–‡æ¡£Dockeré•œåƒ
  build-and-push-docs:
    name: Build & Push Docs Container
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
      image-tags: ${{ steps.meta.outputs.tags }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        platforms: linux/amd64,linux/arm64
        driver-opts: image=moby/buildkit:buildx-stable-1

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Extract metadata for docs image
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          # ä¸ºä¸»åˆ†æ”¯è®¾ç½®latestæ ‡ç­¾
          type=raw,value=latest,enable={{is_default_branch}}
          # æ‰‹åŠ¨è§¦å‘æ—¶ä½¿ç”¨è‡ªå®šä¹‰æ ‡ç­¾
          type=raw,value={{inputs.tag}},enable=${{ github.event_name == 'workflow_dispatch' }}
          # åŸºäºŽæäº¤SHAç”Ÿæˆæ ‡ç­¾
          type=sha,prefix={{branch}}-
          # åŸºäºŽæ—¥æœŸç”Ÿæˆæ ‡ç­¾
          type=raw,value={{date 'YYYYMMDD'}}-{{sha}}
        labels: |
          org.opencontainers.image.title=AIS Documentation
          org.opencontainers.image.description=AISé¡¹ç›®æ–‡æ¡£ç½‘ç«™ - ä¸Šä¸‹æ–‡æ„ŸçŸ¥çš„é”™è¯¯åˆ†æžå­¦ä¹ åŠ©æ‰‹
          org.opencontainers.image.vendor=AIS Team
          org.opencontainers.image.url=https://github.com/kangvcar/ais
          org.opencontainers.image.source=https://github.com/kangvcar/ais
          org.opencontainers.image.documentation=https://github.com/kangvcar/ais/tree/main/docs

    - name: Prepare build context for docs
      run: |
        # ä¸´æ—¶ä½¿ç”¨docsä¸“ç”¨çš„dockerignoreæ–‡ä»¶
        cp .dockerignore .dockerignore.original
        cp .dockerignore.docs .dockerignore

    - name: Build and push docs Docker image
      id: build
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./docs.Dockerfile
        platforms: ${{ github.event.inputs.platforms || 'linux/amd64,linux/arm64' }}
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha,scope=docs
        cache-to: type=gha,mode=max,scope=docs
        # æž„å»ºå‚æ•°
        build-args: |
          BUILD_DATE=${{ github.event.head_commit.timestamp || github.run_id }}
          VCS_REF=${{ github.sha }}
          VERSION=${{ github.ref_name }}

    - name: Restore original dockerignore
      if: always()
      run: |
        # æ¢å¤åŽŸå§‹çš„dockerignoreæ–‡ä»¶
        cp .dockerignore.original .dockerignore
        rm -f .dockerignore.original

    - name: Generate SBOM for docs image
      uses: anchore/sbom-action@v0
      with:
        image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ steps.build.outputs.digest }}
        format: spdx-json
        output-file: docs-sbom.spdx.json

    - name: Security scan docs image with Trivy
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ steps.build.outputs.digest }}
        format: 'sarif'
        output: 'docs-trivy-results.sarif'

    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'docs-trivy-results.sarif'

    - name: Upload docs SBOM as artifact
      uses: actions/upload-artifact@v4
      with:
        name: docs-sbom-${{ github.sha }}
        path: docs-sbom.spdx.json
        retention-days: 30

  # æµ‹è¯•æ–‡æ¡£ç½‘ç«™é•œåƒ
  test-docs-image:
    name: Test Docs Container
    runs-on: ubuntu-latest
    needs: build-and-push-docs
    strategy:
      matrix:
        platform: [linux/amd64, linux/arm64]
    
    steps:
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        platforms: ${{ matrix.platform }}

    - name: Set up QEMU for cross-platform testing
      if: matrix.platform == 'linux/arm64'
      uses: docker/setup-qemu-action@v3
      with:
        platforms: arm64

    - name: Test docs Docker image functionality
      run: |
        # æå–ç¬¬ä¸€ä¸ªæ ‡ç­¾è¿›è¡Œæµ‹è¯•
        IMAGE_TAGS="${{ needs.build-and-push-docs.outputs.image-tags }}"
        IMAGE_DIGEST="${{ needs.build-and-push-docs.outputs.image-digest }}"
        
        IMAGE_TAG=$(echo "$IMAGE_TAGS" | tr '\n' ' ' | tr ',' ' ' | awk '{print $1}' | xargs)
        
        if [ -z "$IMAGE_TAG" ]; then
          if [ -n "$IMAGE_DIGEST" ]; then
            IMAGE_TAG="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@$IMAGE_DIGEST"
          else
            echo "Error: No image tag or digest found"
            exit 1
          fi
        fi
        
        echo "Testing image: $IMAGE_TAG"
        
        # å¯åŠ¨å®¹å™¨å¹¶æµ‹è¯•
        CONTAINER_ID=$(docker run -d --platform ${{ matrix.platform }} -p 8080:80 $IMAGE_TAG)
        
        # ç­‰å¾…å®¹å™¨å¯åŠ¨
        sleep 10
        
        # å¥åº·æ£€æŸ¥
        echo "=== å¥åº·æ£€æŸ¥ ==="
        docker exec $CONTAINER_ID curl -f http://localhost/health
        
        # æµ‹è¯•ä¸»é¡µ
        echo "=== æµ‹è¯•ä¸»é¡µ ==="
        docker exec $CONTAINER_ID curl -f http://localhost/
        
        # æµ‹è¯•é™æ€èµ„æº
        echo "=== æµ‹è¯•é™æ€èµ„æº ==="
        docker exec $CONTAINER_ID ls -la /usr/share/nginx/html/
        
        # éªŒè¯nginxé…ç½®
        echo "=== éªŒè¯nginxé…ç½® ==="
        docker exec $CONTAINER_ID nginx -t
        
        # æ¸…ç†
        docker stop $CONTAINER_ID
        docker rm $CONTAINER_ID

  # æ›´æ–°Docker Hubæè¿°
  update-dockerhub-docs-description:
    name: Update DockerHub Docs Description
    runs-on: ubuntu-latest
    needs: [build-and-push-docs, test-docs-image]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Create Docker Hub README for docs
      run: |
        cat > DOCS_README.md << 'EOF'
        # AIS æ–‡æ¡£ç½‘ç«™

        AIS (AI Shell) é¡¹ç›®çš„å®˜æ–¹æ–‡æ¡£ç½‘ç«™å®¹å™¨é•œåƒã€‚

        ## å…³äºŽ AIS

        AIS æ˜¯ä¸€ä¸ªä¸Šä¸‹æ–‡æ„ŸçŸ¥çš„é”™è¯¯åˆ†æžå­¦ä¹ åŠ©æ‰‹ï¼Œè®©æ¯æ¬¡æŠ¥é”™éƒ½æ˜¯æˆé•¿ã€‚

        ## ä½¿ç”¨æ–¹æ³•

        ```bash
        # å¯åŠ¨æ–‡æ¡£ç½‘ç«™
        docker run -d -p 8080:80 kangvcar/ais-docs:latest
        ```

        ç„¶åŽè®¿é—® http://localhost:8080 æŸ¥çœ‹æ–‡æ¡£ã€‚

        ## ç‰¹æ€§

        - âœ¨ åŸºäºŽ VitePress æž„å»ºçš„çŽ°ä»£åŒ–æ–‡æ¡£ç½‘ç«™
        - ðŸš€ æ”¯æŒå¤šæž¶æž„ (AMD64/ARM64)
        - ðŸ”’ å†…ç½®å®‰å…¨å¤´å’ŒHTTPSæ”¯æŒ
        - ðŸ“± å“åº”å¼è®¾è®¡ï¼Œç§»åŠ¨ç«¯å‹å¥½
        - ðŸŽ¨ æ”¯æŒ Mermaid å›¾è¡¨
        - ðŸ” å†…ç½®æœç´¢åŠŸèƒ½

        ## é¡¹ç›®é“¾æŽ¥

        - ðŸ  [é¡¹ç›®ä¸»é¡µ](https://github.com/kangvcar/ais)
        - ðŸ“š [åœ¨çº¿æ–‡æ¡£](https://ais-docs.vercel.app)
        - ðŸ³ [Docker Hub](https://hub.docker.com/r/kangvcar/ais)

        ## è®¸å¯è¯

        MIT License
        EOF

    - name: Update Docker Hub Description for docs
      uses: peter-evans/dockerhub-description@v4
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
        repository: ${{ env.IMAGE_NAME }}
        short-description: "AISé¡¹ç›®æ–‡æ¡£ç½‘ç«™ - ä¸Šä¸‹æ–‡æ„ŸçŸ¥çš„é”™è¯¯åˆ†æžå­¦ä¹ åŠ©æ‰‹"
        readme-filepath: ./DOCS_README.md

  # éƒ¨ç½²æˆåŠŸé€šçŸ¥
  notify-docs-success:
    name: Notify Docs Deployment Success
    runs-on: ubuntu-latest
    needs: [build-and-push-docs, test-docs-image]
    if: always() && needs.build-and-push-docs.result == 'success' && needs.test-docs-image.result == 'success'
    
    steps:
    - name: Notify success
      run: |
        echo "ðŸ“š AISæ–‡æ¡£ç½‘ç«™æž„å»ºæˆåŠŸï¼"
        echo "ðŸ“‹ é•œåƒæ ‡ç­¾:"
        echo "${{ needs.build-and-push-docs.outputs.image-tags }}"
        echo "ðŸ” é•œåƒæ‘˜è¦: ${{ needs.build-and-push-docs.outputs.image-digest }}"
        echo "ðŸŒ Docker Hub: https://hub.docker.com/r/${{ env.IMAGE_NAME }}"
        echo ""
        echo "ðŸŽ‰ ä½¿ç”¨æ–¹æ³•:"
        echo "docker run -d -p 8080:80 ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
        echo "ç„¶åŽè®¿é—® http://localhost:8080 æŸ¥çœ‹æ–‡æ¡£"

  # éƒ¨ç½²å¤±è´¥é€šçŸ¥
  notify-docs-failure:
    name: Notify Docs Deployment Failure
    runs-on: ubuntu-latest
    needs: [build-and-push-docs, test-docs-image]
    if: always() && (needs.build-and-push-docs.result == 'failure' || needs.test-docs-image.result == 'failure')
    
    steps:
    - name: Notify failure
      run: |
        echo "âŒ AISæ–‡æ¡£ç½‘ç«™Dockeræž„å»ºå¤±è´¥"
        echo "è¯·æ£€æŸ¥æž„å»ºæ—¥å¿—"
        exit 1